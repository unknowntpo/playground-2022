# Dockerfile for PyFlink CDC Application
FROM flink:1.20-scala_2.12-java11

# Install Python 3.11, pip3, and JDK (following ibis-flink-tutorial pattern)
RUN apt-get update -y && \
    apt-get install -y python3.11 python3-pip python3.11-dev python3.11-venv openjdk-11-jdk && \
    rm -rf /var/lib/apt/lists/*

# Set JAVA_HOME (multi-arch support using Docker's TARGETARCH)
ARG TARGETARCH
ENV JAVA_HOME="/usr/lib/jvm/java-11-openjdk-${TARGETARCH}/"
ENV PATH="${JAVA_HOME}/bin:${PATH}"

# Verify JAVA_HOME setup
RUN echo "Architecture: ${TARGETARCH}" && \
    echo "JAVA_HOME: ${JAVA_HOME}" && \
    ls -la ${JAVA_HOME}/include

# Create Python venv
RUN python3.11 -m venv /opt/flink/venv

# Copy requirements.txt (generated by: uv pip compile pyproject.toml -o requirements.txt)
COPY requirements.txt .

# Install Python dependencies (pemja will find JDK headers via JAVA_HOME)
RUN /opt/flink/venv/bin/pip install -r requirements.txt

# Set PATH to use venv
ENV PATH="/opt/flink/venv/bin:$PATH"

# Copy Flink connector JARs to standard location
# Note: JARs are downloaded by download-jars.sh (not in git)
COPY lib/*.jar /opt/flink/usrlib/

# Copy PyFlink job script
COPY flink_cdc_simple.py /opt/flink/job/flink_cdc_simple.py

# Copy entrypoint script
COPY entrypoint.sh /opt/flink/entrypoint.sh
RUN chmod +x /opt/flink/entrypoint.sh

WORKDIR /opt/flink

# Use custom entrypoint
ENTRYPOINT ["/opt/flink/entrypoint.sh"]
